{% extends "user/base.html" %}

{% block title %}My Library - Bookstor{% endblock %}
{% block extra_css %}{% endblock %}

{% block content %}
<!-- Search and Filter Bar -->
<div class="search-filter-bar">
    <div class="search-container">
        <div class="search-input-wrapper">
            <img src="/static/icons/search.svg" width="18" height="18" alt="" aria-hidden="true" class="search-icon" loading="lazy">
            <input
                type="text"
                id="librarySearch"
                class="search-input"
                placeholder="Search by title, author, or category..."
                autocomplete="off"
            >
        </div>
        <div class="filter-buttons">
            <button class="filter-btn active" data-status="all">All Books</button>
            <button class="filter-btn" data-status="currently_reading">Reading</button>
            <button class="filter-btn" data-status="want_to_read">Want to Read</button>
            <button class="filter-btn" data-status="read">Finished</button>
        </div>
        <button class="clear-filters-btn" id="clearFilters" style="display: none;">
            Clear Filters
        </button>
    </div>
</div>
<div class="search-results-info" id="searchResultsInfo" style="display: none;"></div>

{% if books %}
    {% set currently_reading = books | selectattr('reading_status', 'equalto', 'currently_reading') | list %}
    {% set want_to_read = books | selectattr('reading_status', 'equalto', 'want_to_read') | list %}
    {% set read_books = books | selectattr('reading_status', 'equalto', 'read') | list %}

    {% if currently_reading %}
        {% set featured = currently_reading[0] %}
        <div class="library-hero" id="featuredHero">
            {% if featured.thumbnail %}
            <img src="{{ featured.thumbnail }}" alt="{{ featured.title }}" class="hero-background">
            {% endif %}
            <div class="hero-overlay"></div>
            <div class="hero-content">
                {% if featured.thumbnail %}
                <img src="{{ featured.thumbnail }}" alt="{{ featured.title }}" class="hero-cover" loading="lazy">
                {% else %}
                <div class="hero-cover" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 3rem; color:#fff;">
                    <img src="/static/icons/library.svg" width="48" height="48" alt="" aria-hidden="true" loading="lazy" class="icon icon-primary">
                </div>
                {% endif %}
                <div class="hero-info">
                    <div class="hero-badge">Currently Reading</div>
                    <h1 class="hero-title">{{ featured.title }}</h1>
                    {% if featured.authors %}
                    <div class="hero-author">by {{ featured.authors }}</div>
                    {% endif %}
                    <div class="hero-meta">
                        {% if featured.published_date %}
                        <div class="hero-meta-item">{{ featured.published_date[:4] }}</div>
                        {% endif %}
                        {% if featured.page_count %}
                        <div class="hero-meta-item">{{ featured.page_count }} pages</div>
                        {% endif %}
                        {% if featured.book_format %}
                        <div class="hero-meta-item">{{ featured.book_format }}</div>
                        {% endif %}
                    </div>
                    {% if featured.description %}
                    <div class="hero-description">{{ featured.description[:300] }}{% if featured.description|length > 300 %}...{% endif %}</div>
                    {% endif %}
                    <div class="hero-actions">
                        <a href="/app/book/{{ featured.id }}" class="hero-btn hero-btn-primary">View Details</a>
                        <a href="/app/book/{{ featured.id }}" class="hero-btn hero-btn-secondary">More Info</a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Unified Books Grid -->
    <div class="library-section" id="libraryUnified" aria-labelledby="libraryUnifiedTitle">
        <div class="section-header">
            <h2 class="section-title" id="libraryUnifiedTitle">Your Library</h2>
            <span class="section-view-all">{{ books|length }} total</span>
        </div>
        <div class="books-row grid-layout" id="booksUnifiedGrid">
            {% for book in books %}
            <div class="book-card" data-status="{{ book.reading_status }}" style="position:relative;">
                <a href="/app/book/{{ book.id }}" style="display:block; text-decoration:none; color:inherit;">
                    {% if book.thumbnail %}
                    <img src="{{ book.thumbnail }}" alt="{{ book.title }}" class="book-cover js-lazy-fade" loading="lazy">
                    {% else %}
                    <div class="book-cover-placeholder" style="display:flex;align-items:center;justify-content:center;">
                        <img src="/static/icons/library.svg" width="36" height="36" alt="" aria-hidden="true" loading="lazy" class="icon icon-primary">
                    </div>
                    {% endif %}
                    {% if book.reading_status == 'currently_reading' %}
                        <div class="book-card-status status-currently_reading">Reading</div>
                    {% elif book.reading_status == 'want_to_read' %}
                        <div class="book-card-status status-want_to_read">Want to Read</div>
                    {% elif book.reading_status == 'read' %}
                        <div class="book-card-status status-read">Read</div>
                    {% endif %}
                    <div class="book-card-title">{{ book.title }}</div>
                    {% if book.authors %}<div class="book-card-author">{{ book.authors }}</div>{% endif %}
                    <div class="book-card-meta">
                        {% if book.page_count %}<div class="book-card-meta-item">{{ book.page_count }}p</div>{% endif %}
                        {% if book.book_format %}<div class="book-card-meta-item">{{ book.book_format }}</div>{% endif %}
                    </div>
                </a>
                <button type="button" class="edit-cover-icon" data-book-id="{{ book.id }}" aria-label="Edit cover art"><img src="/static/icons/edit.svg" width="16" height="16" alt="" aria-hidden="true" loading="lazy" class="icon icon-secondary"></button>
            </div>
            {% endfor %}
        </div>
    </div>
{% else %}
    <div class="empty-state">
        <div class="empty-state-icon" style="display:flex;align-items:center;justify-content:center;">
            <img src="/static/icons/library.svg" width="48" height="48" alt="" aria-hidden="true" loading="lazy" style="filter:invert(1)">
        </div>
        <div class="empty-state-title">No books in your library yet</div>
        <div class="empty-state-text">Start building your collection by scanning a book or searching for one.</div>
        <a href="/app/search" class="btn btn-primary">Search for Books</a>
    </div>
{% endif %}

<!-- Cover Art Selector Modal -->
<div id="coverSelectorModal" class="cover-selector-modal" role="dialog" aria-modal="true" aria-labelledby="coverSelectorTitle" aria-describedby="coverSelectorDesc">
    <div class="cover-selector-content" tabindex="-1">
        <div class="cover-selector-header">
            <h2 id="coverSelectorTitle" class="cover-selector-title">Select Cover Art</h2>
            <p id="coverSelectorDesc" style="display:none;">Choose an alternative cover image for this book from available sources.</p>
            <button class="cover-selector-close" type="button" onclick="closeCoverSelector()" aria-label="Close cover selector">
                        <img src="/static/icons/logout.svg" width="18" height="18" alt="" aria-hidden="true" loading="lazy" class="icon icon-danger">
            </button>
        </div>
        <div id="coverOptionsContainer">
            <div class="cover-selector-loading">
                <img src="/static/icons/search.svg" width="18" height="18" alt="" aria-hidden="true" loading="lazy" class="icon icon-primary">
                <p>Loading cover art options...</p>
            </div>
        </div>
        <div class="cover-selector-actions">
            <button class="cover-selector-btn cover-selector-btn-cancel" onclick="closeCoverSelector()">Cancel</button>
            <button id="saveCoverBtn" class="cover-selector-btn cover-selector-btn-save" onclick="saveCoverSelection()" disabled>Save</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Search and Filter Functionality
    const searchInput = document.getElementById('librarySearch');
    const filterButtons = document.querySelectorAll('.filter-btn');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const searchResultsInfo = document.getElementById('searchResultsInfo');
    const unifiedGrid = document.getElementById('booksUnifiedGrid');
    const libraryHero = document.getElementById('featuredHero');

    let currentFilter = 'all';
    let currentSearchTerm = '';

    // Get all book cards with their data
    const allBookCards = Array.from(document.querySelectorAll('#booksUnifiedGrid .book-card')).map(card => {
        const title = card.querySelector('.book-card-title')?.textContent.toLowerCase() || '';
        const author = card.querySelector('.book-card-author')?.textContent.toLowerCase() || '';
        const statusBadge = card.querySelector('.book-card-status');
        let status = 'unknown';
        if (statusBadge) {
            if (statusBadge.classList.contains('status-currently_reading')) status = 'currently_reading';
            else if (statusBadge.classList.contains('status-want_to_read')) status = 'want_to_read';
            else if (statusBadge.classList.contains('status-read')) status = 'read';
        }
        return { element: card, title, author, status };
    });

    function applyFilters() {
        let visibleCount = 0;
        let filteredByStatus = 0;
        let filteredBySearch = 0;
        const isFiltering = currentFilter !== 'all' || currentSearchTerm;

        allBookCards.forEach(({ element, title, author, status }) => {
            let visible = true;

            // Apply status filter
            if (currentFilter !== 'all' && status !== currentFilter) {
                visible = false;
                filteredByStatus++;
            }

            // Apply search filter
            if (currentSearchTerm && visible) {
                const searchLower = currentSearchTerm.toLowerCase();
                if (!title.includes(searchLower) && !author.includes(searchLower)) {
                    visible = false;
                    filteredBySearch++;
                }
            }

            element.style.display = visible ? '' : 'none';
            if (visible) visibleCount++;
        });

        // Hide hero if filtering
        if (libraryHero) {
            libraryHero.style.display = isFiltering ? 'none' : '';
        }

        // Update results info
        if (isFiltering) {
            let infoText = `Showing ${visibleCount} of ${allBookCards.length} books`;
            if (currentSearchTerm) {
                infoText += ` matching "${currentSearchTerm}"`;
            }
            if (currentFilter !== 'all') {
                const filterName = filterButtons[Array.from(filterButtons).findIndex(btn => btn.dataset.status === currentFilter)]?.textContent || currentFilter;
                infoText += ` in ${filterName}`;
            }
            searchResultsInfo.textContent = infoText;
            searchResultsInfo.style.display = '';
            clearFiltersBtn.style.display = '';
        } else {
            searchResultsInfo.style.display = 'none';
            clearFiltersBtn.style.display = 'none';
        }
    }

    // Search input handler
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            currentSearchTerm = e.target.value.trim();
            applyFilters();
        });
    }

    // Filter button handlers
    filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            filterButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = btn.dataset.status;
            applyFilters();
        });
    });

    // Clear filters handler
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', () => {
            currentSearchTerm = '';
            currentFilter = 'all';
            if (searchInput) searchInput.value = '';
            filterButtons.forEach(b => b.classList.remove('active'));
            filterButtons[0].classList.add('active');
            applyFilters();
        });
    }

    // Removed custom wheel interception and shift-based horizontal scroll to simplify UX.

    // Cover Art Selector Functionality
    let currentBookId = null;
    let selectedCoverUrl = null;

    async function openCoverSelector(bookId) {
        currentBookId = bookId;
        selectedCoverUrl = null;

        const modal = document.getElementById('coverSelectorModal');
        const container = document.getElementById('coverOptionsContainer');
        const saveBtn = document.getElementById('saveCoverBtn');

        // Show modal
        modal.classList.add('active');

        // Reset state
    container.innerHTML = '<div class="cover-selector-loading"><img src="/static/icons/search.svg" width="24" height="24" alt="" aria-hidden="true" loading="lazy" class="icon icon-primary"><p>Loading cover art options...</p></div>';
        saveBtn.disabled = true;

        try {
            // Fetch cover art options from API
            const response = await fetch(`/api/books/${bookId}/cover-options`);

            if (!response.ok) {
                throw new Error('Failed to fetch cover art options');
            }

            const data = await response.json();

            if (data.options.length === 0) {
                container.innerHTML = '<div class="cover-selector-loading"><p>No cover art options available for this book.</p></div>';
                return;
            }

            // Render cover options
            const grid = document.createElement('div');
            grid.className = 'cover-options-grid';

            data.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'cover-option';
                optionDiv.dataset.url = option.url;

                // Mark current cover as selected
                if (option.url === data.current_cover) {
                    optionDiv.classList.add('selected');
                    selectedCoverUrl = option.url;
                    saveBtn.disabled = false;
                }

                optionDiv.innerHTML = `
                    <img src="${option.url}" alt="Cover option from ${option.source}" onerror="this.parentElement.style.display='none';">
                    <div class="cover-option-label">${option.source}</div>
                `;

                optionDiv.addEventListener('click', () => {
                    // Remove selected class from all options
                    document.querySelectorAll('.cover-option').forEach(opt => opt.classList.remove('selected'));

                    // Add selected class to clicked option
                    optionDiv.classList.add('selected');
                    selectedCoverUrl = option.url;
                    saveBtn.disabled = false;
                });

                grid.appendChild(optionDiv);
            });

            container.innerHTML = '';
            container.appendChild(grid);

        } catch (error) {
            console.error('Error loading cover art options:', error);
            container.innerHTML = '<div class="cover-selector-loading"><p>Error loading cover art options. Please try again.</p></div>';
        }
    }

    function closeCoverSelector() {
        const modal = document.getElementById('coverSelectorModal');
        modal.classList.remove('active');
        currentBookId = null;
        selectedCoverUrl = null;
    }

    async function saveCoverSelection() {
        if (!currentBookId || !selectedCoverUrl) {
            return;
        }

        const saveBtn = document.getElementById('saveCoverBtn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        try {
            const response = await fetch(`/api/books/${currentBookId}/cover`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    cover_url: selectedCoverUrl
                })
            });

            if (!response.ok) {
                throw new Error('Failed to update cover art');
            }

            // Reload the page to show the new cover
            window.location.reload();

        } catch (error) {
            console.error('Error saving cover art:', error);
            alert('Failed to update cover art. Please try again.');
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save';
        }
    }

    // Delegate edit-cover-icon clicks
    document.addEventListener('click', (e) => {
        const target = e.target.closest('.edit-cover-icon');
        if (target && target.dataset.bookId) {
            e.preventDefault();
            e.stopPropagation();
            openCoverSelector(target.dataset.bookId);
        }
    });

    // Close modal when clicking outside
    const modalRoot = document.getElementById('coverSelectorModal');
    modalRoot.addEventListener('click', (e) => {
        if (e.target.id === 'coverSelectorModal') {
            closeCoverSelector();
        }
    });

    // Accessibility: focus trap & ESC close
    function trapFocus(modal) {
        const focusableSelectors = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
        const focusable = Array.from(modal.querySelectorAll(focusableSelectors)).filter(el => !el.disabled && el.offsetParent !== null);
        if (focusable.length) {
            focusable[0].focus();
        }
        function handleKey(e) {
            if (e.key === 'Escape') {
                closeCoverSelector();
                return;
            }
            if (e.key === 'Tab') {
                const first = focusable[0];
                const last = focusable[focusable.length - 1];
                if (e.shiftKey && document.activeElement === first) {
                    e.preventDefault();
                    last.focus();
                } else if (!e.shiftKey && document.activeElement === last) {
                    e.preventDefault();
                    first.focus();
                }
            }
        }
        modal.addEventListener('keydown', handleKey);
        modal.dataset.trapActive = 'true';
    }

    // Hook into openCoverSelector to apply focus trap after options load
    const originalOpenCoverSelector = openCoverSelector;
    openCoverSelector = async function(bookId) {
        await originalOpenCoverSelector(bookId);
        // Small delay to allow dynamic content injection
        setTimeout(() => {
            const modalContent = document.querySelector('#coverSelectorModal .cover-selector-content');
            if (modalContent) {
                trapFocus(modalContent);
            }
        }, 50);
    };
</script>
{% endblock %}

