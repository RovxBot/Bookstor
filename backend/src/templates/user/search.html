{% extends "user/base.html" %}

{% block title %}Search & Add Books - Bookstor{% endblock %}

{% block extra_css %}
<style>
    .search-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    @media (max-width: 768px) {
        .search-container {
            padding: 1rem;
        }
    }

    .search-box {
        background-color: var(--surface);
        border-radius: var(--radius-md);
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow);
    }

    @media (max-width: 768px) {
        .search-box {
            padding: 1rem;
            margin-bottom: 1rem;
        }
    }

    .search-form {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        align-items: flex-start;
    }

    @media (max-width: 768px) {
        .search-form {
            flex-direction: column;
            gap: 0.75rem;
        }
    }

    .search-input {
        flex: 1;
        padding: 0.875rem 1rem;
        border: 2px solid var(--border);
        border-radius: var(--radius-sm);
        font-size: 1rem;
        background-color: var(--background);
        color: var(--text-primary);
        transition: border-color 0.2s;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary-colour);
    }

    .isbn-input {
        width: 200px;
        padding: 0.875rem 1rem;
        border: 2px solid var(--border);
        border-radius: var(--radius-sm);
        font-size: 1rem;
        background-color: var(--background);
        color: var(--text-primary);
        transition: border-color 0.2s;
    }

    @media (max-width: 768px) {
        .isbn-input {
            width: 100%;
        }
    }

    .isbn-input:focus {
        outline: none;
        border-color: var(--primary-colour);
    }

    .search-results {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 2rem;
    }

    /* Mobile: 2 columns for search results */
    @media (max-width: 768px) {
        .search-results {
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
    }

    /* Very small screens: 1 column */
    @media (max-width: 400px) {
        .search-results {
            grid-template-columns: 1fr;
        }
    }

    .result-card {
        background-color: var(--surface);
        border-radius: var(--radius-md);
        overflow: hidden;
        box-shadow: var(--shadow);
        transition: all 0.3s;
    }

    .result-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    /* Disable hover effect on touch devices */
    @media (hover: none) {
        .result-card:hover {
            transform: none;
        }
    }

    .result-cover {
        width: 100%;
        height: 300px;
        object-fit: cover;
        background-color: var(--background);
    }

    @media (max-width: 768px) {
        .result-cover {
            height: 220px;
        }
    }

    .result-cover-placeholder {
        width: 100%;
        height: 300px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 4rem;
    }

    @media (max-width: 768px) {
        .result-cover-placeholder {
            height: 220px;
            font-size: 3rem;
        }
    }

    .result-info {
        padding: 1.5rem;
    }

    @media (max-width: 768px) {
        .result-info {
            padding: 1rem;
        }
    }

    .result-title {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    }

    @media (max-width: 768px) {
        .result-title {
            font-size: 0.95rem;
        }
    }

    .result-authors {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 0.75rem;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    }

    @media (max-width: 768px) {
        .result-authors {
            font-size: 0.8rem;
        }
    }

    .result-meta {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-bottom: 1rem;
    }

    @media (max-width: 768px) {
        .result-meta {
            font-size: 0.7rem;
            margin-bottom: 0.75rem;
        }
    }

    .result-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        flex: 1;
        min-width: 100px;
    }

    @media (max-width: 768px) {
        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            min-width: 80px;
        }
    }

    .loading {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary);
    }

    .spinner {
        border: 3px solid var(--border);
        border-top: 3px solid var(--primary-colour);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .empty-results {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary);
    }

    .tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid var(--border);
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .tabs::-webkit-scrollbar {
        display: none;
    }

    @media (max-width: 768px) {
        .tabs {
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
    }

    .tab {
        padding: 0.75rem 1.5rem;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-weight: 500;
        color: var(--text-secondary);
        transition: all 0.2s;
        white-space: nowrap;
        flex-shrink: 0;
    }

    @media (max-width: 768px) {
        .tab {
            padding: 0.625rem 1rem;
            font-size: 0.9rem;
        }
    }

    .tab:hover {
        color: var(--text-primary);
    }

    .tab.active {
        color: var(--primary-colour);
        border-bottom-color: var(--primary-colour);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <h1>Search & Add Books</h1>
    <p>Search for books to add to your library or wishlist</p>
</div>

<div class="search-container">
    <div class="search-box">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('search', this)">Search by Title/Author</button>
            <button class="tab" onclick="switchTab('isbn', this)">Add by ISBN</button>
        </div>

        <!-- Search Tab -->
        <div id="searchTab" class="tab-content active">
            <form class="search-form" onsubmit="performImmediateSearch(event)">
                <input 
                    type="text" 
                    class="search-input" 
                    id="searchQuery" 
                    placeholder="Search by title, author, or keyword..."
                    autocomplete="off"
                    required
                >
                <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                    <select id="formatFilter" class="isbn-input" style="width:auto;" aria-label="Filter by format">
                        <option value="">All Formats</option>
                        <option value="Hardcover">Hardcover</option>
                        <option value="Paperback">Paperback</option>
                        <option value="eBook">eBook</option>
                    </select>
                    <input type="number" id="yearFrom" class="isbn-input" placeholder="Year from" min="1800" max="2100" style="width:140px;" aria-label="Publication year from">
                    <input type="number" id="yearTo" class="isbn-input" placeholder="Year to" min="1800" max="2100" style="width:140px;" aria-label="Publication year to">
                </div>
                <button type="submit" class="btn btn-primary" aria-label="Search now">Search</button>
                <button type="button" class="btn btn-secondary" onclick="clearSearchFilters()" aria-label="Clear filters">Clear</button>
            </form>
        </div>

        <!-- ISBN Tab -->
        <div id="isbnTab" class="tab-content">
            <form class="search-form" onsubmit="addByISBN(event)">
                <div style="display:flex; flex-direction:column; gap:0.35rem; flex:1;">
                    <input 
                        type="text" 
                        class="isbn-input" 
                        id="isbnInput" 
                        placeholder="Enter ISBN (10 or 13 digits)"
                        inputmode="numeric"
                        autocomplete="off"
                        aria-describedby="isbnHelp isbnError"
                        required
                    >
                    <div id="isbnError" style="display:none; color: var(--danger-colour); font-size:0.75rem;"></div>
                    <div id="isbnHelp" style="color: var(--text-secondary); font-size: 0.7rem;">Non-digits will be stripped automatically. Accepts ISBN-10 or ISBN-13.</div>
                </div>
                <div class="dropdown" style="position:relative;">
                    <button type="button" class="btn btn-primary" id="addIsbnPrimary" aria-haspopup="true" aria-expanded="false">Add Book ▾</button>
                    <div id="addIsbnMenu" class="dropdown-menu" style="display:none; position:absolute; top:100%; left:0; background:var(--surface); border:1px solid var(--border); border-radius:6px; min-width:180px; box-shadow:var(--shadow); z-index:30;">
                        <button type="submit" class="btn btn-secondary" style="width:100%; justify-content:flex-start;" aria-label="Add to Library">Add to Library</button>
                        <button type="button" class="btn btn-secondary" onclick="addToWishlist()" style="width:100%; justify-content:flex-start;" aria-label="Add to Wishlist">Add to Wishlist</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Searching...</p>
    </div>

    <!-- Results -->
    <div id="results" class="search-results"></div>
    
    <!-- Empty State -->
    <div id="emptyState" class="empty-results" style="display: none;">
        <p>No results found. Try a different search term.</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentTab = 'search';

    function switchTab(tab, btnEl) {
        currentTab = tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        if(btnEl) btnEl.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(tab + 'Tab').classList.add('active');
        document.getElementById('results').innerHTML = '';
        document.getElementById('emptyState').style.display = 'none';
    }

    // ==================== Debounced Search & Facets ====================
    let searchDebounceTimer = null;
    const DEBOUNCE_MS = 350;
    const searchInputEl = document.getElementById('searchQuery');
    const formatFilterEl = document.getElementById('formatFilter');
    const yearFromEl = document.getElementById('yearFrom');
    const yearToEl = document.getElementById('yearTo');

    function buildSearchUrl(query){
        const params = new URLSearchParams();
        params.set('q', query);
        // Facet parameters (passed to backend which may ignore unknown ones for now)
        if(formatFilterEl.value) params.set('format', formatFilterEl.value);
        const yf = yearFromEl.value.trim();
        const yt = yearToEl.value.trim();
        if(yf) params.set('year_from', yf);
        if(yt) params.set('year_to', yt);
        return `/api/books/search?${params.toString()}`;
    }

    async function performSearch(query){
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const emptyState = document.getElementById('emptyState');
        loading.style.display='block';
        results.innerHTML='';
        emptyState.style.display='none';
        try {
            const url = buildSearchUrl(query);
            const response = await fetch(url, {credentials:'same-origin'});
            if(!response.ok){
                throw new Error('Search failed');
            }
            let books = await response.json();
            const exclusion = [/boxed set/i, /box set/i, /omnibus/i, /collection/i, /set of/i];
            if(Array.isArray(books)) {
                books = books.filter(b => !exclusion.some(rx => rx.test((b.title||''))));
            } else {
                books = [];
            }
            loading.style.display='none';
            if(!Array.isArray(books) || books.length===0){
                emptyState.style.display='block';
                return;
            }
            results.innerHTML = books.map(book => createBookCard(book)).join('');
        } catch(err){
            loading.style.display='none';
            showToast('Search failed. Please try again.', {type:'error'});
        }
    }

    function scheduleSearch(){
        const query = searchInputEl.value.trim();
        if(!query){
            document.getElementById('results').innerHTML='';
            document.getElementById('emptyState').style.display='none';
            return;
        }
        if(searchDebounceTimer) clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(()=> performSearch(query), DEBOUNCE_MS);
    }

    function performImmediateSearch(event){
        event.preventDefault();
        const query = searchInputEl.value.trim();
        if(query){ performSearch(query); }
    }

    function clearSearchFilters(){
        searchInputEl.value='';
        formatFilterEl.value='';
        yearFromEl.value='';
        yearToEl.value='';
        document.getElementById('results').innerHTML='';
        document.getElementById('emptyState').style.display='none';
    }

    // Bind debounce listeners
    searchInputEl.addEventListener('input', scheduleSearch);
    formatFilterEl.addEventListener('change', scheduleSearch);
    yearFromEl.addEventListener('change', scheduleSearch);
    yearToEl.addEventListener('change', scheduleSearch);

    function createBookCard(book) {
        const thumbnail = book.thumbnail || '';
        const authors = book.authors ? book.authors.join(', ') : 'Unknown Author';
        const year = book.published_date ? book.published_date.substring(0, 4) : '';
        const pages = book.page_count ? `${book.page_count} pages` : '';
        const dataAttrs = `data-book='${JSON.stringify({title:book.title, authors:book.authors, thumbnail:book.thumbnail, isbn:book.isbn})}'`;
        return `
            <div class="result-card" ${dataAttrs}>
                ${thumbnail ? 
                    `<img src="${thumbnail}" alt="${book.title}" class="result-cover" loading="lazy">` :
                    `<div class="result-cover-placeholder" style="display:flex;align-items:center;justify-content:center;">
                        <img src="/static/icons/library.svg" width="48" height="48" alt="" aria-hidden="true" loading="lazy" style="filter:invert(1)">
                    </div>`
                }
                <div class="result-info">
                    <div class="result-title">${book.title}</div>
                    <div class="result-authors">${authors}</div>
                    <div class="result-meta">${year} ${pages ? '• ' + pages : ''}</div>
                    <div class="result-actions">
                        <button class="btn btn-primary btn-sm" data-action="add-library">Add to Library</button>
                        <button class="btn btn-secondary btn-sm" data-action="add-wishlist">Wishlist</button>
                    </div>
                </div>
            </div>
        `;
    }

    // Event delegation for add actions
    document.getElementById('results').addEventListener('click', async (e)=> {
        const actionBtn = e.target.closest('button[data-action]');
        if(!actionBtn) return;
        const card = actionBtn.closest('.result-card');
        if(!card) return;
        try {
            const bookData = JSON.parse(card.getAttribute('data-book'));
            if(actionBtn.dataset.action==='add-library') {
                await addBook(bookData, 'want_to_read', false);
            } else if(actionBtn.dataset.action==='add-wishlist') {
                await addBook(bookData, 'wishlist', true);
            }
        } catch(err){
            showToast('Failed to process book data.', {type:'error'});
        }
    });
    // Unified ISBN dropdown toggle
    const addIsbnPrimary = document.getElementById('addIsbnPrimary');
    const addIsbnMenu = document.getElementById('addIsbnMenu');
    addIsbnPrimary.addEventListener('click', ()=> {
        const expanded = addIsbnPrimary.getAttribute('aria-expanded') === 'true';
        addIsbnPrimary.setAttribute('aria-expanded', String(!expanded));
        addIsbnMenu.style.display = expanded ? 'none' : 'block';
    });
    document.addEventListener('click', (e)=> {
        if(!addIsbnMenu.contains(e.target) && e.target !== addIsbnPrimary){
            addIsbnMenu.style.display='none';
            addIsbnPrimary.setAttribute('aria-expanded','false');
        }
    });

    // Close dropdown with ESC
    addIsbnPrimary.addEventListener('keydown', (e)=> { if(e.key==='Escape'){ addIsbnMenu.style.display='none'; addIsbnPrimary.setAttribute('aria-expanded','false'); } });
    addIsbnMenu.addEventListener('keydown', (e)=> { if(e.key==='Escape'){ addIsbnMenu.style.display='none'; addIsbnPrimary.setAttribute('aria-expanded','false'); addIsbnPrimary.focus(); } });

    async function addBook(book, readingStatus, isWishlist) {
        try {
            // Show loading indicator
            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            // Prepare minimal data - the backend will fetch complete data via ISBN
            const bookData = {
                title: book.title,
                authors: book.authors ? book.authors.join(', ') : null,
                thumbnail: book.thumbnail,
                isbn: book.isbn,  // This triggers full ISBN lookup on backend
                reading_status: readingStatus,
                is_wishlist: isWishlist
            };

            // Use the new from-search endpoint that does ISBN lookup
            const response = await fetch('/api/books/from-search', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin',
                body: JSON.stringify(bookData)
            });

            loading.style.display = 'none';

            if (response.ok) {
                const addedBook = await response.json();
                showToast(`"${book.title}" added to your ${isWishlist ? 'wishlist' : 'library'}!`, {type:'success'});
                window.location.href = `/app/book/${addedBook.id}`;
            } else {
                const error = await response.json();
                showToast(`Failed to add book: ${error.detail || 'It may already be in your library.'}`, {type:'error'});
            }
        } catch (error) {
            document.getElementById('loading').style.display = 'none';
            console.error('Add book error:', error);
            showToast('Failed to add book. Please try again.', {type:'error'});
        }
    }

    async function addByISBN(event) {
        event.preventDefault();
        const raw = document.getElementById('isbnInput').value;
        const isbn = sanitizeISBN(raw);
        if(!validateISBNLength(isbn)) {
            showISBNError('ISBN must be 10 or 13 digits after cleaning.');
            return;
        }

        // Show loading indicator
        const loading = document.getElementById('loading');
        loading.style.display = 'block';

        try {
            console.log('Looking up ISBN:', isbn);

            const response = await fetch('/api/books/isbn/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify({
                    isbn: isbn,
                    reading_status: 'want_to_read',
                    is_wishlist: false
                })
            });

            loading.style.display = 'none';

            if (response.ok) {
                const book = await response.json();
                showToast(`"${book.title}" added to your library!`, {type:'success'});
                window.location.href = `/app/book/${book.id}`;
            } else {
                const error = await response.json();
                console.error('ISBN lookup error:', error);
                showToast(`Failed to add book: ${error.detail || 'Unknown error'}`, {type:'error'});
            }
        } catch (error) {
            loading.style.display = 'none';
            console.error('ISBN lookup failed:', error);
            showToast('Failed to add book. Please try again.', {type:'error'});
        }
    }

    async function addToLibrary() {
        const raw = document.getElementById('isbnInput').value;
        const isbn = sanitizeISBN(raw);
        if (!isbn) {
            showISBNError('Please enter an ISBN');
            return;
        }
        if(!validateISBNLength(isbn)) {
            showISBNError('ISBN must be 10 or 13 digits after cleaning.');
            return;
        }

        const loading = document.getElementById('loading');
        loading.style.display = 'block';

        try {
            const response = await fetch('/api/books/isbn/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify({
                    isbn: isbn,
                    reading_status: 'want_to_read',
                    is_wishlist: false
                })
            });

            loading.style.display = 'none';

            if (response.ok) {
                const book = await response.json();
                showToast(`"${book.title}" added to your library!`, {type:'success'});
                window.location.href = `/app/book/${book.id}`;
            } else {
                const error = await response.json();
                showToast(`Failed to add book: ${error.detail || 'Unknown error'}`, {type:'error'});
            }
        } catch (error) {
            loading.style.display = 'none';
            showToast('Failed to add book. Please try again.', {type:'error'});
        }
    }

    async function addToWishlist() {
        const raw = document.getElementById('isbnInput').value;
        const isbn = sanitizeISBN(raw);
        if (!isbn) {
            showISBNError('Please enter an ISBN');
            return;
        }
        if(!validateISBNLength(isbn)) {
            showISBNError('ISBN must be 10 or 13 digits after cleaning.');
            return;
        }

        const loading = document.getElementById('loading');
        loading.style.display = 'block';

        try {
            const response = await fetch('/api/books/isbn/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify({
                    isbn: isbn,
                    reading_status: 'wishlist',
                    is_wishlist: true
                })
            });

            loading.style.display = 'none';

            if (response.ok) {
                const book = await response.json();
                showToast(`"${book.title}" added to your wishlist!`, {type:'success'});
                window.location.href = `/app/book/${book.id}`;
            } else {
                const error = await response.json();
                showToast(`Failed to add book: ${error.detail || 'Unknown error'}`, {type:'error'});
            }
        } catch (error) {
            loading.style.display = 'none';
            showToast('Failed to add book. Please try again.', {type:'error'});
        }
    }
    // ==================== ISBN Sanitization & Validation ====================
    function sanitizeISBN(value) {
        return (value||'').replace(/[^0-9Xx]/g,'').toUpperCase(); // keep digits and allow X for ISBN-10 check digit
    }
    function validateISBNLength(isbn) {
        return isbn.length === 10 || isbn.length === 13;
    }
    function showISBNError(msg) {
        const el = document.getElementById('isbnError');
        if(!el) return;
        el.textContent = msg;
        el.style.display = 'block';
        el.setAttribute('role','alert');
        showToast(msg, {type:'error'});
    }
    function clearISBNError(){
        const el = document.getElementById('isbnError');
        if(!el) return;
        el.textContent='';
        el.style.display='none';
        el.removeAttribute('role');
    }
    const isbnInputEl = document.getElementById('isbnInput');
    if(isbnInputEl){
        isbnInputEl.addEventListener('input', (e)=> {
            const cleaned = sanitizeISBN(e.target.value);
            e.target.value = cleaned; // mutate to cleaned
            if(cleaned.length===0){
                clearISBNError();
                return;
            }
            if(validateISBNLength(cleaned)) {
                clearISBNError();
            } else {
                const remain = cleaned.length < 10 ? (10 - cleaned.length) : (cleaned.length>10 && cleaned.length<13 ? (13 - cleaned.length) : 0);
                if(remain>0){
                    const targetLen = cleaned.length < 10 ? 10 : 13;
                    document.getElementById('isbnError').style.display='block';
                    document.getElementById('isbnError').textContent = `Need ${remain} more digit${remain===1?'':'s'} for ISBN-${targetLen}`;
                } else if(!validateISBNLength(cleaned)) {
                    showISBNError('ISBN must be 10 or 13 digits.');
                }
            }
        });
    }
</script>
{% endblock %}

