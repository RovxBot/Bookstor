{% extends "user/base.html" %}

{% block title %}{{ book.title }} - Bookstor{% endblock %}

{% block extra_css %}
<style>
    /* Netflix-inspired Hero Section */
    .book-hero {
        position: relative;
        height: 80vh;
        min-height: 600px;
        background: var(--background);
        overflow: hidden;
    }

    .book-hero-background {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        filter: blur(20px);
        transform: scale(1.1);
        opacity: 0.3;
    }

    .book-hero-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(to right, var(--background) 0%, rgba(0,0,0,0.3) 50%, var(--background) 100%),
                    linear-gradient(to top, var(--background) 0%, transparent 50%);
    }

    .book-hero-content {
        position: relative;
        z-index: 2;
        max-width: 1400px;
        margin: 0 auto;
        padding: 4rem 2rem;
        height: 100%;
        display: flex;
        align-items: center;
        gap: 3rem;
    }

    .book-cover-large {
        width: 350px;
        height: 525px;
        object-fit: cover;
        border-radius: 12px;
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
        transition: transform 0.3s;
    }

    .book-cover-large:hover {
        transform: scale(1.02);
    }

    .book-cover-placeholder-large {
        width: 350px;
        height: 525px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 8rem;
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
    }

    .book-hero-info {
        flex: 1;
        color: var(--text-primary);
    }

    .book-status-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .badge-want_to_read {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
    }

    .badge-currently_reading {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
    }

    .badge-read {
        background: rgba(139, 92, 246, 0.2);
        color: #8b5cf6;
    }

    .book-hero-title {
        font-size: 3.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        line-height: 1.1;
    }

    .book-hero-authors {
        font-size: 1.75rem;
        opacity: 0.8;
        margin-bottom: 1.5rem;
    }

    .book-meta {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
        margin-bottom: 2rem;
        font-size: 1.125rem;
    }

    .book-meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        opacity: 0.9;
    }

    .book-meta-item ion-icon {
        font-size: 1.5rem;
    }

    .book-description-preview {
        font-size: 1.125rem;
        line-height: 1.7;
        margin-bottom: 2rem;
        max-width: 800px;
        opacity: 0.9;
    }

    .book-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .hero-btn {
        padding: 1rem 2rem;
        font-size: 1.125rem;
        font-weight: 600;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        transition: all 0.3s;
        text-decoration: none;
    }

    .hero-btn ion-icon {
        font-size: 1.5rem;
    }

    .hero-btn-primary {
        background: var(--primary-colour);
        color: white;
    }

    .hero-btn-primary:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 30px rgba(0, 122, 255, 0.3);
    }

    .hero-btn-secondary {
        background: var(--surface);
        color: var(--text-primary);
    }

    .hero-btn-secondary:hover {
        background: var(--border);
    }

    .book-detail-content {
        max-width: 1400px;
        margin: 0 auto;
        padding: 3rem 2rem;
    }

    .detail-section {
        background-color: var(--surface);
        border-radius: 12px;
        padding: 2.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        border: 1px solid var(--border);
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .section-title ion-icon {
        font-size: 1.75rem;
        color: var(--primary-colour);
    }

    /* Info Grid */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .info-label {
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
    }

    .info-value {
        font-size: 1.125rem;
        color: var(--text-primary);
        font-weight: 500;
    }

    .reading-status-selector {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .status-btn {
        padding: 0.75rem 1.5rem;
        border: 2px solid var(--border);
        background-color: var(--surface);
        color: var(--text-primary);
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
    }

    .status-btn:hover {
        border-color: var(--primary-colour);
    }

    .status-btn.active {
        background-color: var(--primary-colour);
        color: white;
        border-color: var(--primary-colour);
    }

    .notes-textarea {
        width: 100%;
        min-height: 150px;
        padding: 1rem;
        border: 2px solid var(--border);
        border-radius: 0.5rem;
        font-family: inherit;
        font-size: 0.95rem;
        resize: vertical;
        background-color: var(--background);
        color: var(--text-primary);
    }

    .notes-textarea:focus {
        outline: none;
        border-color: var(--primary-colour);
    }

    .btn-group {
        display: flex;
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .wishlist-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border: 2px solid var(--border);
        background-color: var(--surface);
        color: var(--text-primary);
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
    }

    .wishlist-toggle.active {
        background-color: #fef3c7;
        border-color: #fbbf24;
        color: #92400e;
    }

    .wishlist-toggle:hover {
        border-color: #fbbf24;
    }

    .delete-btn {
        margin-left: auto;
    }

    .book-description {
        line-height: 1.8;
        color: var(--text-primary);
    }

    .book-categories {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .category-badge {
        padding: 0.375rem 0.75rem;
        background-color: var(--background);
        border-radius: 1rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-primary);
    }

    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        background-color: var(--surface);
        color: var(--text-primary);
        font-size: 1rem;
        transition: all 0.2s;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary-colour);
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    select.form-input {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        padding-right: 2.5rem;
    }

    textarea.form-input {
        resize: vertical;
        min-height: 100px;
        font-family: inherit;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .book-hero {
            height: auto;
            min-height: auto;
        }

        .book-hero-content {
            flex-direction: column;
            padding: 2rem 1rem;
            text-align: center;
        }

        .book-cover-large,
        .book-cover-placeholder-large {
            width: 250px;
            height: 375px;
        }

        .book-hero-title {
            font-size: 2rem;
        }

        .book-hero-authors {
            font-size: 1.25rem;
        }

        .book-meta {
            justify-content: center;
            font-size: 1rem;
        }

        .book-description-preview {
            font-size: 1rem;
        }

        .book-actions {
            flex-direction: column;
            width: 100%;
        }

        .hero-btn {
            width: 100%;
            justify-content: center;
        }

        .book-detail-content {
            padding: 2rem 1rem;
        }

        .detail-section {
            padding: 1.5rem;
        }

        .section-title {
            font-size: 1.25rem;
        }

        .info-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="book-hero">
    {% if book.thumbnail %}
    <img src="{{ book.thumbnail }}" alt="{{ book.title }}" class="book-hero-background">
    {% endif %}
    <div class="book-hero-overlay"></div>
    <div class="book-hero-content">
        {% if book.thumbnail %}
        <img src="{{ book.thumbnail }}" alt="{{ book.title }}" class="book-cover-large">
        {% else %}
        <div class="book-cover-placeholder-large">📚</div>
        {% endif %}

        <div class="book-hero-info">
            <div class="book-status-badge badge-{{ book.reading_status }}">
                {% if book.reading_status == 'want_to_read' %}
                Want to Read
                {% elif book.reading_status == 'currently_reading' %}
                Currently Reading
                {% elif book.reading_status == 'read' %}
                Finished
                {% endif %}
            </div>
            <h1 class="book-hero-title">{{ book.title }}</h1>
            {% if book.subtitle %}
            <div class="book-hero-authors" style="font-size: 1.25rem; margin-bottom: 0.5rem;">{{ book.subtitle }}</div>
            {% endif %}
            {% if book.authors %}
            <div class="book-hero-authors">by {{ book.authors }}</div>
            {% endif %}

            <div class="book-meta">
                {% if book.published_date %}
                <div class="book-meta-item">
                    <ion-icon name="calendar-outline"></ion-icon>
                    {{ book.published_date[:4] }}
                </div>
                {% endif %}
                {% if book.page_count %}
                <div class="book-meta-item">
                    <ion-icon name="document-text-outline"></ion-icon>
                    {{ book.page_count }} pages
                </div>
                {% endif %}
                {% if book.book_format %}
                <div class="book-meta-item">
                    <ion-icon name="albums-outline"></ion-icon>
                    {{ book.book_format }}
                </div>
                {% endif %}
                {% if book.edition %}
                <div class="book-meta-item">
                    <ion-icon name="bookmark-outline"></ion-icon>
                    {{ book.edition }}
                </div>
                {% endif %}
            </div>

            {% if book.description %}
            <div class="book-description-preview">
                {{ book.description[:250] }}{% if book.description|length > 250 %}...{% endif %}
            </div>
            {% endif %}

            <div class="book-actions">
                <button type="button" class="hero-btn hero-btn-primary" onclick="refreshMetadata()">
                    <ion-icon name="refresh-outline"></ion-icon>
                    Refresh Metadata
                </button>
                {% if book.is_wishlist %}
                <button type="button" class="hero-btn hero-btn-secondary" onclick="markAsPurchased()">
                    <ion-icon name="cart-outline"></ion-icon>
                    Purchased
                </button>
                {% else %}
                <button type="button" class="hero-btn hero-btn-secondary" onclick="addToWishlist()">
                    <ion-icon name="heart-outline"></ion-icon>
                    Add to Wishlist
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="book-detail-content">
    <!-- Book Information Grid -->
    <div class="detail-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 class="section-title" style="margin: 0;">
                <ion-icon name="information-circle-outline"></ion-icon>
                Book Information
            </h2>
            <button type="button" class="btn btn-secondary" onclick="toggleEditMode()" id="editToggleBtn">
                <ion-icon name="create-outline"></ion-icon>
                Edit
            </button>
        </div>

        <!-- View Mode -->
        <div id="viewMode">
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Title</div>
                    <div class="info-value">{{ book.title }}</div>
                </div>
                {% if book.subtitle %}
                <div class="info-item">
                    <div class="info-label">Subtitle</div>
                    <div class="info-value">{{ book.subtitle }}</div>
                </div>
                {% endif %}
                <div class="info-item">
                    <div class="info-label">Author(s)</div>
                    <div class="info-value">{{ book.authors }}</div>
                </div>
                {% if book.isbn %}
                <div class="info-item">
                    <div class="info-label">ISBN</div>
                    <div class="info-value">{{ book.isbn }}</div>
                </div>
                {% endif %}
                {% if book.publisher %}
                <div class="info-item">
                    <div class="info-label">Publisher</div>
                    <div class="info-value">{{ book.publisher }}</div>
                </div>
                {% endif %}
                {% if book.published_date %}
                <div class="info-item">
                    <div class="info-label">Published</div>
                    <div class="info-value">{{ book.published_date }}</div>
                </div>
                {% endif %}
                {% if book.page_count %}
                <div class="info-item">
                    <div class="info-label">Pages</div>
                    <div class="info-value">{{ book.page_count }}</div>
                </div>
                {% endif %}
                {% if book.book_format %}
                <div class="info-item">
                    <div class="info-label">Format</div>
                    <div class="info-value">{{ book.book_format }}</div>
                </div>
                {% endif %}
                {% if book.edition %}
                <div class="info-item">
                    <div class="info-label">Edition</div>
                    <div class="info-value">{{ book.edition }}</div>
                </div>
                {% endif %}
                {% if book.series_name %}
                <div class="info-item">
                    <div class="info-label">Series</div>
                    <div class="info-value">
                        {{ book.series_name }}
                        {% if book.series_position %} #{{ book.series_position }}{% endif %}
                    </div>
                </div>
                {% endif %}
                {% if book.added_at %}
                <div class="info-item">
                    <div class="info-label">Added to Library</div>
                    <div class="info-value">{{ book.added_at.strftime('%B %d, %Y') }}</div>
                </div>
                {% endif %}
            </div>
            {% if book.categories %}
            <div style="margin-top: 1.5rem;">
                <div class="info-label" style="margin-bottom: 0.75rem;">Categories</div>
                <div class="book-categories">
                    {% for category in book.categories.split(',') %}
                    <span class="category-badge">{{ category.strip() }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Edit Mode -->
        <div id="editMode" style="display: none;">
            <form id="bookInfoForm">
                <div class="form-group">
                    <label for="edit_title">Title</label>
                    <input type="text" class="form-input" id="edit_title" name="title" value="{{ book.title }}" required>
                </div>
                <div class="form-group">
                    <label for="edit_subtitle">Subtitle</label>
                    <input type="text" class="form-input" id="edit_subtitle" name="subtitle" value="{{ book.subtitle or '' }}">
                </div>
                <div class="form-group">
                    <label for="edit_authors">Author(s)</label>
                    <input type="text" class="form-input" id="edit_authors" name="authors" value="{{ book.authors }}" required>
                </div>
                <div class="form-group">
                    <label for="edit_publisher">Publisher</label>
                    <input type="text" class="form-input" id="edit_publisher" name="publisher" value="{{ book.publisher or '' }}">
                </div>
                <div class="form-group">
                    <label for="edit_published_date">Published Date</label>
                    <input type="text" class="form-input" id="edit_published_date" name="published_date" value="{{ book.published_date or '' }}" placeholder="YYYY-MM-DD or YYYY">
                </div>
                <div class="form-group">
                    <label for="edit_page_count">Page Count</label>
                    <input type="number" class="form-input" id="edit_page_count" name="page_count" value="{{ book.page_count or '' }}">
                </div>
                <div class="form-group">
                    <label for="edit_book_format">Format</label>
                    <select class="form-input" id="edit_book_format" name="book_format">
                        <option value="">Select format</option>
                        <option value="Paperback" {% if book.book_format == 'Paperback' %}selected{% endif %}>Paperback</option>
                        <option value="Hardcover" {% if book.book_format == 'Hardcover' %}selected{% endif %}>Hardcover</option>
                        <option value="eBook" {% if book.book_format == 'eBook' %}selected{% endif %}>eBook</option>
                        <option value="Audiobook" {% if book.book_format == 'Audiobook' %}selected{% endif %}>Audiobook</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit_edition">Edition</label>
                    <input type="text" class="form-input" id="edit_edition" name="edition" value="{{ book.edition or '' }}" placeholder="e.g., 1st Edition, Revised">
                </div>
                <div class="form-group">
                    <label for="edit_series_name">Series Name</label>
                    <input type="text" class="form-input" id="edit_series_name" name="series_name" value="{{ book.series_name or '' }}">
                </div>
                <div class="form-group">
                    <label for="edit_series_position">Series Position</label>
                    <input type="text" class="form-input" id="edit_series_position" name="series_position" value="{{ book.series_position or '' }}" placeholder="e.g., 1 or 1.5">
                </div>
                <div class="form-group">
                    <label for="edit_categories">Categories (comma-separated)</label>
                    <input type="text" class="form-input" id="edit_categories" name="categories" value="{{ book.categories or '' }}" placeholder="Fiction, Fantasy, Adventure">
                </div>
                <div class="form-group">
                    <label for="edit_description">Description</label>
                    <textarea class="form-input" id="edit_description" name="description" rows="6" placeholder="Book description...">{{ book.description or '' }}</textarea>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" onclick="saveBookInfo()">
                        <ion-icon name="save-outline"></ion-icon>
                        Save Changes
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="toggleEditMode()">
                        <ion-icon name="close-outline"></ion-icon>
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Description -->
    {% if book.description %}
    <div class="detail-section">
        <h2 class="section-title">
            <ion-icon name="book-outline"></ion-icon>
            Description
        </h2>
        <div class="book-description">{{ book.description }}</div>
    </div>
    {% endif %}

    <!-- Reading Status -->
    <div class="detail-section">
        <h2 class="section-title">
            <ion-icon name="bookmark-outline"></ion-icon>
            Reading Status
        </h2>
        <form method="POST" action="/api/books/{{ book.id }}" id="statusForm">
            <div class="reading-status-selector">
                <button type="button" class="status-btn {% if book.reading_status == 'want_to_read' %}active{% endif %}"
                        onclick="updateStatus('want_to_read', this)">
                    Want to Read
                </button>
                <button type="button" class="status-btn {% if book.reading_status == 'currently_reading' %}active{% endif %}"
                        onclick="updateStatus('currently_reading', this)">
                    Currently Reading
                </button>
                <button type="button" class="status-btn {% if book.reading_status == 'read' %}active{% endif %}"
                        onclick="updateStatus('read', this)">
                    Read
                </button>
            </div>
        </form>
    </div>

    <!-- Notes -->
    <div class="detail-section">
        <h2 class="section-title">
            <ion-icon name="create-outline"></ion-icon>
            My Notes
        </h2>
        <form method="POST" action="/api/books/{{ book.id }}" id="notesForm">
            <textarea class="notes-textarea" name="notes" id="notes"
                      placeholder="Add your personal notes about this book...">{{ book.notes or '' }}</textarea>
            <div class="btn-group">
                <button type="button" class="btn btn-primary" onclick="saveNotes()">Save Notes</button>
            </div>
        </form>
    </div>

    <!-- Delete -->
    <div class="detail-section">
        <h2 class="section-title">
            <ion-icon name="warning-outline"></ion-icon>
            Danger Zone
        </h2>
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
            Deleting this book will permanently remove it from your library. This action cannot be undone.
        </p>
        <button type="button" class="btn btn-danger" onclick="deleteBook()">
            <ion-icon name="trash-outline"></ion-icon>
            Delete Book
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function updateStatus(status, buttonElement) {
        try {
            const response = await fetch('/api/books/{{ book.id }}', {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin',
                body: JSON.stringify({reading_status: status})
            });

            console.log('Update status response:', response.status, response.ok);

            if (response.ok) {
                // Update UI
                document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
                buttonElement.classList.add('active');
                showNotification('Reading status updated!', 'success');
            } else {
                const errorData = await response.json();
                console.error('Update status error:', errorData);
                showNotification('Failed to update status: ' + (errorData.detail || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Update status error:', error);
            showNotification('Failed to update status', 'error');
        }
    }

    async function addToWishlist() {
        try {
            const response = await fetch('/api/books/{{ book.id }}', {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin',
                body: JSON.stringify({is_wishlist: true})
            });

            if (response.ok) {
                showNotification('Added to wishlist!', 'success');
                location.reload();
            } else {
                const errorData = await response.json();
                console.error('Add to wishlist error:', errorData);
                showNotification('Failed to add to wishlist: ' + (errorData.detail || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Add to wishlist error:', error);
            showNotification('Failed to add to wishlist', 'error');
        }
    }

    async function markAsPurchased() {
        if (!confirm('Mark this book as purchased? This will move it from your wishlist to your library.')) {
            return;
        }

        try {
            const response = await fetch('/api/books/{{ book.id }}', {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin',
                body: JSON.stringify({
                    is_wishlist: false,
                    reading_status: 'want_to_read'
                })
            });

            if (response.ok) {
                showNotification('Book marked as purchased and moved to library!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                const errorData = await response.json();
                console.error('Mark as purchased error:', errorData);
                showNotification('Failed to mark as purchased: ' + (errorData.detail || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Mark as purchased error:', error);
            showNotification('Failed to mark as purchased', 'error');
        }
    }

    function toggleEditMode() {
        const viewMode = document.getElementById('viewMode');
        const editMode = document.getElementById('editMode');
        const editBtn = document.getElementById('editToggleBtn');

        if (editMode.style.display === 'none') {
            // Switch to edit mode
            viewMode.style.display = 'none';
            editMode.style.display = 'block';
            editBtn.innerHTML = '<ion-icon name="eye-outline"></ion-icon> View';
        } else {
            // Switch to view mode
            viewMode.style.display = 'block';
            editMode.style.display = 'none';
            editBtn.innerHTML = '<ion-icon name="create-outline"></ion-icon> Edit';
        }
    }

    async function saveBookInfo() {
        const form = document.getElementById('bookInfoForm');
        const formData = new FormData(form);

        // Convert FormData to JSON
        const data = {};
        for (const [key, value] of formData.entries()) {
            if (value !== '') {
                // Convert page_count to number if present
                if (key === 'page_count' && value) {
                    data[key] = parseInt(value);
                } else {
                    data[key] = value;
                }
            }
        }

        try {
            const response = await fetch('/api/books/{{ book.id }}', {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showNotification('Book information updated!', 'success');
                // Reload page to show updated data
                setTimeout(() => location.reload(), 1000);
            } else {
                const errorData = await response.json();
                console.error('Save book info error:', errorData);
                showNotification('Failed to save: ' + (errorData.detail || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Save book info error:', error);
            showNotification('Failed to save book information', 'error');
        }
    }

    async function saveNotes() {
        const notes = document.getElementById('notes').value;

        try {
            const response = await fetch('/api/books/{{ book.id }}', {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin',
                body: JSON.stringify({notes: notes})
            });

            if (response.ok) {
                showNotification('Notes saved!', 'success');
            } else {
                const errorData = await response.json();
                console.error('Save notes error:', errorData);
                showNotification('Failed to save notes: ' + (errorData.detail || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Save notes error:', error);
            showNotification('Failed to save notes', 'error');
        }
    }

    async function saveSeries() {
        const seriesName = document.getElementById('series_name').value.trim();
        const seriesPosition = document.getElementById('series_position').value.trim();

        try {
            const response = await fetch('/api/books/{{ book.id }}', {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin',
                body: JSON.stringify({
                    series_name: seriesName || null,
                    series_position: seriesPosition || null
                })
            });

            if (response.ok) {
                showNotification('Series information saved!', 'success');
                // Reload to update any collection links
                setTimeout(() => location.reload(), 1000);
            } else {
                const errorData = await response.json();
                console.error('Save series error:', errorData);
                showNotification('Failed to save series info: ' + (errorData.detail || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Save series error:', error);
            showNotification('Failed to save series info', 'error');
        }
    }

    async function refreshMetadata() {
        if (!confirm('This will fetch updated information from Open Library and Google Books (Open Library preferred). All metadata will be refreshed. Continue?')) {
            return;
        }

        try {
            showNotification('Refreshing metadata from Open Library and Google Books...', 'info');

            const response = await fetch('/api/books/{{ book.id }}/refresh-metadata', {
                method: 'POST',
                credentials: 'same-origin'
            });

            if (response.ok) {
                showNotification('Metadata refreshed successfully! Reloading...', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                const errorData = await response.json();
                console.error('Refresh metadata error:', errorData);
                showNotification('Failed to refresh metadata: ' + (errorData.detail || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Refresh metadata error:', error);
            showNotification('Failed to refresh metadata', 'error');
        }
    }

    async function deleteBook() {
        if (!confirm('Are you sure you want to delete this book from your library?')) {
            return;
        }

        try {
            const response = await fetch('/api/books/{{ book.id }}', {
                method: 'DELETE',
                credentials: 'same-origin'
            });

            if (response.ok) {
                showNotification('Book deleted!', 'success');
                setTimeout(() => window.location.href = '/app/library', 1000);
            }
        } catch (error) {
            showNotification('Failed to delete book', 'error');
        }
    }

    function showNotification(message, type) {
        // Simple notification - you can enhance this
        alert(message);
    }
</script>
{% endblock %}

